<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提现</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: radial-gradient(circle at 50% 20%, #9b111e 0%, #3f0006 100%);
            font-family: 'Noto Sans SC', sans-serif;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(6px);
        }
    </style>
</head>

<body class="min-h-screen text-yellow-100">
    <div class="max-w-md mx-auto px-4 py-6">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-yellow-200">提现</h1>
            <a href="/wallet" class="text-sm text-yellow-200/70">返回资金</a>
        </div>

        <div id="loginTip" class="mt-6 hidden bg-black/40 border border-yellow-500/30 rounded-xl p-4 text-sm">
            请先登录，再进行提现。
            <div class="mt-3">
                <a href="/" class="text-yellow-200 underline underline-offset-4">去登录</a>
            </div>
        </div>

        <div id="withdrawPanel" class="mt-6 bg-black/30 border border-yellow-500/30 rounded-2xl p-5">
            <div class="text-xs text-yellow-200/60">当前余额（元）</div>
            <div class="text-2xl font-bold font-mono mt-2" id="balanceText">0.00</div>

            <div id="alipayBoundInfo" class="mt-4 hidden">
                <div class="text-xs text-yellow-200/60">已绑定支付宝</div>
                <div class="text-sm text-yellow-100 mt-1" id="alipayBoundText">--</div>
                <button onclick="showBindForm()" class="mt-2 text-xs text-yellow-200/70 underline underline-offset-4">修改绑定信息</button>
            </div>

            <div id="alipayBindForm" class="mt-4 space-y-2">
                <div>
                    <label class="text-xs text-yellow-200/70">姓名（必填）</label>
                    <input id="alipayNameInput"
                        class="w-full bg-black/30 text-white px-3 py-2 rounded-lg border border-yellow-500/30"
                        placeholder="真实姓名" />
                </div>
                <div>
                    <label class="text-xs text-yellow-200/70">支付宝账号（必填）</label>
                    <input id="alipayAccountInput"
                        class="w-full bg-black/30 text-white px-3 py-2 rounded-lg border border-yellow-500/30"
                        placeholder="手机号 / 邮箱" />
                </div>
                <button onclick="bindAlipay()"
                    class="w-full bg-emerald-400 text-red-900 font-bold py-2 rounded-lg">绑定支付宝</button>
            </div>

            <div class="mt-5 space-y-2">
                <label class="text-xs text-yellow-200/70">提现金额（元）</label>
                <input id="withdrawAmountInput"
                    class="w-full bg-black/30 text-white px-3 py-2 rounded-lg border border-yellow-500/30"
                    placeholder="例如 50" type="number" />
                <button id="withdrawSubmitBtn" onclick="submitWithdraw()"
                    class="w-full bg-yellow-400 text-red-900 font-bold py-2 rounded-lg">提交提现</button>
                <div id="withdrawStatus" class="text-xs text-yellow-200/70"></div>
            </div>
        </div>
    </div>

    <div id="withdrawSuccessModal" onclick="goWithdrawList()"
        class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div onclick="event.stopPropagation()"
            class="bg-gradient-to-b from-red-600 to-red-900 p-1 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="bg-red-800 rounded-xl p-6 text-center border border-yellow-500/50">
                <div class="text-2xl font-bold text-yellow-200">提现已提交</div>
                <div id="withdrawSuccessText" class="text-sm text-yellow-100/80 mt-2">处理中...</div>
                <button onclick="goWithdrawList()"
                    class="mt-5 w-full bg-yellow-400 text-red-900 font-bold py-2 rounded-lg">查看提现记录</button>
                <div class="text-xs text-yellow-200/70 mt-2">点击按钮返回提现清单</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let authToken = localStorage.getItem('hb_token') || '';
        let walletInfo = { balance: 0, alipay: { bound: false } };
        let withdrawSubmitting = false;
        let withdrawCooldownEnd = 0;
        let withdrawCooldownTimer = null;
        let lastWithdrawRequestId = '';
        let lastWithdrawRequestAt = 0;
        const withdrawCooldownMs = 5000;

        function apiFetch(path, options = {}) {
            const headers = options.headers || {};
            if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
            headers['Content-Type'] = 'application/json';
            return fetch(API_BASE + path, { ...options, headers });
        }

        function fenToYuan(fen) {
            const val = Number(fen || 0);
            return (val / 100).toFixed(2);
        }

        function yuanToFen(yuan) {
            const val = parseFloat(String(yuan || '0'));
            if (!Number.isFinite(val)) return 0;
            return Math.round(val * 100);
        }

        function showLoginTip() {
            document.getElementById('loginTip').classList.remove('hidden');
            document.getElementById('withdrawPanel').classList.add('hidden');
        }

        function updateWithdrawButton() {
            const btn = document.getElementById('withdrawSubmitBtn');
            if (!btn) return;
            const remaining = Math.max(0, withdrawCooldownEnd - Date.now());
            let label = '提交提现';
            let disabled = false;
            if (walletInfo.withdraw_enabled === false) {
                disabled = true;
            }
            if (withdrawSubmitting) {
                label = '处理中...';
                disabled = true;
            } else if (remaining > 0) {
                label = `请稍候(${Math.ceil(remaining / 1000)}s)`;
                disabled = true;
            }
            btn.innerText = label;
            btn.disabled = disabled;
            btn.classList.toggle('opacity-50', disabled);
            btn.classList.toggle('cursor-not-allowed', disabled);
        }

        function startWithdrawCooldown() {
            withdrawCooldownEnd = Date.now() + withdrawCooldownMs;
            if (withdrawCooldownTimer) {
                clearInterval(withdrawCooldownTimer);
            }
            withdrawCooldownTimer = setInterval(() => {
                if (Date.now() >= withdrawCooldownEnd) {
                    clearInterval(withdrawCooldownTimer);
                    withdrawCooldownTimer = null;
                }
                updateWithdrawButton();
            }, 200);
            updateWithdrawButton();
        }

        function makeRequestId() {
            if (window.crypto && window.crypto.getRandomValues) {
                const buf = new Uint8Array(8);
                window.crypto.getRandomValues(buf);
                return Array.from(buf).map(b => b.toString(16).padStart(2, '0')).join('');
            }
            return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
        }

        function getWithdrawRequestId() {
            if (lastWithdrawRequestId && Date.now() - lastWithdrawRequestAt < 15000) {
                return lastWithdrawRequestId;
            }
            lastWithdrawRequestId = makeRequestId();
            lastWithdrawRequestAt = Date.now();
            return lastWithdrawRequestId;
        }

        function showWithdrawSuccess(text) {
            const modal = document.getElementById('withdrawSuccessModal');
            const msg = document.getElementById('withdrawSuccessText');
            if (msg) msg.innerText = text || '提现处理中';
            if (modal) modal.classList.remove('hidden');
        }

        function goWithdrawList() {
            window.location.href = '/wallet';
        }

        function renderAlipay(forceBind = false) {
            const bindForm = document.getElementById('alipayBindForm');
            const boundInfo = document.getElementById('alipayBoundInfo');
            const boundText = document.getElementById('alipayBoundText');
            if (!walletInfo.alipay || !walletInfo.alipay.bound || forceBind) {
                bindForm.classList.remove('hidden');
                boundInfo.classList.add('hidden');
                return;
            }
            bindForm.classList.add('hidden');
            boundInfo.classList.remove('hidden');
            const idCardMasked = walletInfo.alipay.id_card_masked || '';
            const name = walletInfo.alipay.name || '';
            const baseText = name
                ? `${name} | ${walletInfo.alipay.account_masked}`
                : `${walletInfo.alipay.account_masked}`;
            boundText.innerText = idCardMasked
                ? `${baseText} | ${idCardMasked}`
                : baseText;
        }

        function showBindForm() {
            renderAlipay(true);
        }

        function loadWallet() {
            apiFetch('/api/user/wallet').then(res => res.json()).then(data => {
                if (data.error) {
                    document.getElementById('withdrawStatus').innerText = data.error;
                    return;
                }
                walletInfo = data || { balance: 0, alipay: { bound: false } };
                document.getElementById('balanceText').innerText = fenToYuan(walletInfo.balance);
                const enabled = walletInfo.withdraw_enabled !== false;
                const btn = document.getElementById('withdrawSubmitBtn');
                if (btn) {
                    btn.disabled = !enabled;
                    btn.classList.toggle('opacity-50', !enabled);
                    btn.classList.toggle('cursor-not-allowed', !enabled);
                }
                if (!enabled) {
                    document.getElementById('withdrawStatus').innerText = '提现申请已暂停，请稍后再试';
                }
                renderAlipay(false);
                updateWithdrawButton();
            });
        }

        function bindAlipay() {
            const name = document.getElementById('alipayNameInput').value.trim();
            const account = document.getElementById('alipayAccountInput').value.trim();
            if (!name) {
                document.getElementById('withdrawStatus').innerText = '姓名为必填，请填写真实姓名';
                return;
            }
            if (!account) {
                document.getElementById('withdrawStatus').innerText = '请填写支付宝账号';
                return;
            }
            document.getElementById('withdrawStatus').innerText = '绑定中...';
            apiFetch('/api/user/alipay/bind', {
                method: 'POST',
                body: JSON.stringify({ name, account })
            }).then(res => res.json()).then(data => {
                if (data.error) {
                    document.getElementById('withdrawStatus').innerText = data.error;
                    return;
                }
                document.getElementById('withdrawStatus').innerText = '绑定成功';
                loadWallet();
            }).catch(() => {
                document.getElementById('withdrawStatus').innerText = '绑定失败，请稍后重试';
            });
        }

        function submitWithdraw() {
            if (withdrawSubmitting || Date.now() < withdrawCooldownEnd) {
                return;
            }
            if (walletInfo.withdraw_enabled === false) {
                document.getElementById('withdrawStatus').innerText = '提现申请已暂停，请稍后再试';
                return;
            }
            const amountFen = yuanToFen(document.getElementById('withdrawAmountInput').value.trim());
            if (amountFen <= 0) {
                document.getElementById('withdrawStatus').innerText = '请输入正确金额';
                return;
            }
            if (amountFen < 10) {
                document.getElementById('withdrawStatus').innerText = '最低提现金额为 0.1 元';
                return;
            }
            if (!walletInfo.alipay || !walletInfo.alipay.bound) {
                document.getElementById('withdrawStatus').innerText = '请先绑定支付宝';
                return;
            }
            withdrawSubmitting = true;
            startWithdrawCooldown();
            document.getElementById('withdrawStatus').innerText = '提现处理中...';
            apiFetch('/api/user/withdraw', {
                method: 'POST',
                body: JSON.stringify({ amount: amountFen, request_id: getWithdrawRequestId() })
            }).then(res => res.json()).then(data => {
                withdrawSubmitting = false;
                if (data.error) {
                    document.getElementById('withdrawStatus').innerText = data.error;
                    updateWithdrawButton();
                    return;
                }
                const status = (data.status || '').toLowerCase();
                const statusMap = {
                    paid: '提现已到账',
                    processing: '提现处理中',
                    pending: '已提交，等待处理',
                    waiting_funds: '余额不足，等待资金补充',
                    failed: '提现失败',
                    refunded: '提现失败已退款'
                };
                const msg = statusMap[status] || '已提交提现';
                document.getElementById('withdrawStatus').innerText = msg;
                showWithdrawSuccess(msg);
                if (typeof data.balance !== 'undefined') {
                    walletInfo.balance = data.balance;
                    document.getElementById('balanceText').innerText = fenToYuan(walletInfo.balance);
                }
                updateWithdrawButton();
            }).catch(() => {
                withdrawSubmitting = false;
                document.getElementById('withdrawStatus').innerText = '提交失败，请稍后重试';
                updateWithdrawButton();
            });
        }

        if (!authToken) {
            showLoginTip();
        } else {
            loadWallet();
        }
    </script>
</body>

</html>
